<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quiz Game - Kahoot Clone</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --primary-color: #46178f;
            --secondary-color: #ff6b6b;
            --success-color: #0cb80c;
            --danger-color: #e21b3c;
            --warning-color: #ffa602;
            --info-color: #1368ce;
            --dark: #333333;
            --light: #f2f2f2;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, #7c4dff 100%);
            min-height: 100vh;
            color: white;
        }

        .main-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .navbar {
            background: rgba(0, 0, 0, 0.2) !important;
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
        }

        .navbar-brand {
            font-size: 2rem;
            font-weight: bold;
            color: white !important;
        }

        .nav-link {
            color: white !important;
            margin: 0 10px;
            transition: transform 0.3s;
        }

        .nav-link:hover {
            transform: scale(1.1);
        }

        .content-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }

        .game-card {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            color: var(--dark);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            animation: slideUp 0.5s ease;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .btn-game {
            padding: 15px 40px;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 10px;
            border: none;
            transition: all 0.3s;
            margin: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-primary-game {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary-game:hover {
            background: #5a2eb0;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(70, 23, 143, 0.4);
        }

        .btn-success-game {
            background: var(--success-color);
            color: white;
        }

        .btn-success-game:hover {
            background: #0a9a0a;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(12, 184, 12, 0.4);
        }

        .btn-warning-game {
            background: var(--warning-color);
            color: white;
        }

        .btn-warning-game:hover {
            background: #e59400;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(255, 166, 2, 0.4);
        }

        .room-card {
            background: linear-gradient(135deg, var(--primary-color), #7c4dff);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin: 1rem 0;
            cursor: pointer;
            transition: all 0.3s;
        }

        .room-card:hover {
            transform: translateX(10px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
        }

        .quiz-option {
            background: white;
            border: 3px solid var(--light);
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--dark);
        }

        .quiz-option:hover {
            transform: scale(1.02);
            border-color: var(--primary-color);
        }

        .quiz-option.selected {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .quiz-option.correct {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .quiz-option.incorrect {
            background: var(--danger-color);
            color: white;
            border-color: var(--danger-color);
        }

        .timer {
            font-size: 3rem;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
        }

        .timer.warning {
            color: var(--warning-color);
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .podium {
            display: flex;
            justify-content: center;
            align-items: flex-end;
            margin: 2rem 0;
        }

        .podium-place {
            text-align: center;
            margin: 0 20px;
            animation: bounceIn 0.5s ease;
        }

        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }

        .podium-1 {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            height: 200px;
            width: 150px;
            border-radius: 10px 10px 0 0;
        }

        .podium-2 {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            height: 150px;
            width: 150px;
            border-radius: 10px 10px 0 0;
        }

        .podium-3 {
            background: linear-gradient(135deg, #cd7f32, #e8a75d);
            height: 100px;
            width: 150px;
            border-radius: 10px 10px 0 0;
        }

        .vip-badge {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: var(--dark);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            display: inline-block;
            animation: shine 2s infinite;
        }

        @keyframes shine {
            0% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
            50% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.8); }
            100% { box-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }
        }

        .loading-spinner {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 10px;
        }

        .player-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .player-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 10px;
            margin: 5px 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .ready-badge {
            background: var(--success-color);
            color: white;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
        }

        .room-code {
            background: var(--dark);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 2rem;
            font-weight: bold;
            text-align: center;
            letter-spacing: 3px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .room-code:hover {
            background: var(--primary-color);
            transform: scale(1.05);
        }

        .theme-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            border-radius: 15px;
            padding: 20px;
            margin: 10px;
            cursor: pointer;
            transition: all 0.3s;
            color: white;
        }

        .theme-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        .theme-card.selected {
            border: 3px solid var(--warning-color);
            transform: scale(1.05);
        }

        @media (max-width: 768px) {
            .game-card {
                padding: 1rem;
            }
            
            .btn-game {
                padding: 10px 20px;
                font-size: 1rem;
            }
            
            .podium-place {
                margin: 0 10px;
            }
            
            .podium-1, .podium-2, .podium-3 {
                width: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Navbar -->
        <nav class="navbar navbar-expand-lg">
            <div class="container-fluid">
                <a class="navbar-brand" href="#dashboard">
                    <i class="fas fa-gamepad"></i> Quiz Game
                </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarNav">
                    <ul class="navbar-nav ms-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="#dashboard">
                                <i class="fas fa-home"></i> Início
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#search">
                                <i class="fas fa-search"></i> Pesquisar
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="vipBtn">
                                <i class="fas fa-crown"></i> VIP
                            </a>
                        </li>
                        <li class="nav-item" id="userInfo" style="display: none;">
                            <a class="nav-link" href="#">
                                <img id="userAvatar" class="user-avatar" src="" alt="Avatar">
                                <span id="userName"></span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#" id="loginBtn">
                                <i class="fas fa-sign-in-alt"></i> Login
                            </a>
                        </li>
                        <li class="nav-item" id="logoutItem" style="display: none;">
                            <a class="nav-link" href="#" id="logoutBtn">
                                <i class="fas fa-sign-out-alt"></i> Sair
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <!-- Content Area -->
        <div class="content-area">
            <!-- Login Page -->
            <div id="loginPage" class="page active">
                <div class="game-card text-center">
                    <h1 class="mb-4">
                        <i class="fas fa-gamepad fa-3x mb-3 d-block" style="color: var(--primary-color);"></i>
                        Bem-vindo ao Quiz Game!
                    </h1>
                    <p class="mb-4">Entre com sua conta Google para começar a jogar</p>
                    <button id="googleLoginBtn" class="btn btn-primary-game">
                        <i class="fab fa-google"></i> Entrar com Google
                    </button>
                </div>
            </div>

            <!-- Dashboard -->
            <div id="dashboardPage" class="page">
                <div class="game-card">
                    <h2 class="text-center mb-4">Menu Principal</h2>
                    <div class="text-center">
                        <button class="btn btn-success-game" onclick="showCreateRoom()">
                            <i class="fas fa-plus-circle"></i> Criar Sala
                        </button>
                        <button class="btn btn-primary-game" onclick="showJoinRoom()">
                            <i class="fas fa-door-open"></i> Entrar em Sala
                        </button>
                        <button class="btn btn-warning-game" onclick="showPublicRooms()">
                            <i class="fas fa-globe"></i> Salas Públicas
                        </button>
                    </div>
                </div>
            </div>

            <!-- Create Room -->
            <div id="createRoomPage" class="page">
                <div class="game-card">
                    <h2 class="text-center mb-4">Criar Nova Sala</h2>
                    <form id="createRoomForm">
                        <div class="mb-3">
                            <label class="form-label">Nome da Sala</label>
                            <input type="text" class="form-control" id="roomName" required>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Visibilidade</label>
                            <select class="form-select" id="roomVisibility">
                                <option value="public">Pública</option>
                                <option value="friends">Somente Amigos</option>
                                <option value="private">Privada</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Máximo de Jogadores</label>
                            <input type="number" class="form-control" id="maxPlayers" min="2" max="6" value="6">
                            <small class="text-muted">VIP: Pode ter mais de 6 jogadores</small>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Mínimo de Jogadores</label>
                            <input type="number" class="form-control" id="minPlayers" min="2" max="6" value="2">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Tempo por Pergunta (segundos)</label>
                            <input type="number" class="form-control" id="questionTime" min="5" max="60" value="20">
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="showAnswers" checked>
                            <label class="form-check-label" for="showAnswers">
                                Mostrar resposta correta após cada pergunta
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="simultaneousAnswers" checked>
                            <label class="form-check-label" for="simultaneousAnswers">
                                Todos respondem ao mesmo tempo
                            </label>
                        </div>
                        
                        <div class="text-center">
                            <button type="submit" class="btn btn-success-game">
                                <i class="fas fa-check"></i> Criar Sala
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="showDashboard()">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Join Room -->
            <div id="joinRoomPage" class="page">
                <div class="game-card">
                    <h2 class="text-center mb-4">Entrar em Sala</h2>
                    <div class="mb-4">
                        <label class="form-label">Código da Sala</label>
                        <input type="text" class="form-control text-center" id="roomCodeInput" 
                               placeholder="Digite o código da sala" style="font-size: 1.5rem; letter-spacing: 2px;">
                    </div>
                    <div class="text-center">
                        <button class="btn btn-primary-game" onclick="joinRoomByCode()">
                            <i class="fas fa-sign-in-alt"></i> Entrar
                        </button>
                        <button class="btn btn-secondary" onclick="showDashboard()">
                            Voltar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Public Rooms -->
            <div id="publicRoomsPage" class="page">
                <div class="game-card">
                    <h2 class="text-center mb-4">Salas Públicas</h2>
                    <div id="publicRoomsList">
                        <!-- Rooms will be loaded here -->
                    </div>
                    <div class="text-center mt-4">
                        <button class="btn btn-secondary" onclick="showDashboard()">
                            Voltar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Room Lobby -->
            <div id="roomLobbyPage" class="page">
                <div class="game-card">
                    <h2 class="text-center mb-4" id="lobbyRoomName">Sala de Espera</h2>
                    
                    <div class="room-code mb-4" onclick="copyRoomCode()">
                        <i class="fas fa-copy"></i> <span id="lobbyRoomCode">ABC123</span>
                    </div>
                    
                    <div class="mb-4">
                        <h4>Jogadores (<span id="currentPlayersCount">1</span>/<span id="maxPlayersCount">6</span>)</h4>
                        <div class="player-list" id="playersList">
                            <!-- Players will be listed here -->
                        </div>
                    </div>
                    
                    <div class="text-center">
                        <button id="readyBtn" class="btn btn-success-game" onclick="toggleReady()">
                            <i class="fas fa-check"></i> Pronto
                        </button>
                        <button id="startGameBtn" class="btn btn-warning-game" onclick="selectTheme()" style="display: none;">
                            <i class="fas fa-play"></i> Iniciar Jogo
                        </button>
                        <button class="btn btn-danger" onclick="leaveRoom()">
                            <i class="fas fa-door-open"></i> Sair da Sala
                        </button>
                    </div>
                </div>
            </div>

            <!-- Theme Selection -->
            <div id="themeSelectionPage" class="page">
                <div class="game-card">
                    <h2 class="text-center mb-4">Selecione o Tema</h2>
                    <div class="row" id="themesList">
                        <!-- Themes will be loaded here -->
                    </div>
                    <div class="text-center mt-4">
                        <button class="btn btn-primary-game" onclick="startGame()">
                            <i class="fas fa-play"></i> Começar Quiz
                        </button>
                    </div>
                </div>
            </div>

            <!-- Game Page -->
            <div id="gamePage" class="page">
                <div class="game-card">
                    <div class="timer" id="gameTimer">20</div>
                    
                    <div class="mb-4">
                        <h3 class="text-center" id="questionText">Pergunta aparecerá aqui</h3>
                        <div class="progress mt-3">
                            <div class="progress-bar" id="questionProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div id="answersContainer">
                        <!-- Options will be loaded here -->
                    </div>
                    
                    <div class="text-center mt-4">
                        <button id="submitAnswerBtn" class="btn btn-primary-game" onclick="submitAnswer()" style="display: none;">
                            <i class="fas fa-check"></i> Confirmar Resposta
                        </button>
                    </div>
                </div>
            </div>

            <!-- Results Page -->
            <div id="resultsPage" class="page">
                <div class="game-card">
                    <h2 class="text-center mb-4">🏆 Pódio 🏆</h2>
                    
                    <div class="podium" id="podiumContainer">
                        <!-- Podium will be rendered here -->
                    </div>
                    
                    <div id="fullResultsList" class="mt-4">
                        <!-- Full results will be listed here -->
                    </div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-primary-game" onclick="backToLobby()">
                            <i class="fas fa-redo"></i> Jogar Novamente
                        </button>
                        <button class="btn btn-secondary" onclick="showDashboard()">
                            <i class="fas fa-home"></i> Menu Principal
                        </button>
                    </div>
                </div>
            </div>

            <!-- Search Page -->
            <div id="searchPage" class="page">
                <div class="game-card">
                    <h2 class="text-center mb-4">Pesquisar</h2>
                    <div class="input-group mb-4">
                        <input type="text" class="form-control" id="searchInput" placeholder="Pesquisar salas, temas ou jogadores...">
                        <button class="btn btn-primary" onclick="performSearch()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                    <div id="searchResults">
                        <!-- Search results will appear here -->
                    </div>
                    <div class="text-center mt-4">
                        <button class="btn btn-secondary" onclick="showDashboard()">
                            Voltar
                        </button>
                    </div>
                </div>
            </div>

            <!-- VIP Page -->
            <div id="vipPage" class="page">
                <div class="game-card text-center">
                    <h2 class="mb-4">
                        <i class="fas fa-crown" style="color: gold;"></i> Seja VIP
                    </h2>
                    <p>Desbloqueie recursos exclusivos:</p>
                    <ul class="text-start">
                        <li>Salas com mais de 6 jogadores</li>
                        <li>Temas exclusivos</li>
                        <li>Estatísticas avançadas</li>
                        <li>Badge VIP dourado</li>
                        <li>Sem anúncios</li>
                    </ul>
                    <div class="mt-4">
                        <h3>R$ 9,90/mês</h3>
                        <button class="btn btn-warning-game" onclick="initiateMercadoPagoCheckout()">
                            <i class="fas fa-shopping-cart"></i> Assinar VIP
                        </button>
                    </div>
                    <div class="text-center mt-4">
                        <button class="btn btn-secondary" onclick="showDashboard()">
                            Voltar
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-analytics.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, getDoc, getDocs, updateDoc, deleteDoc, query, where, onSnapshot, serverTimestamp, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBbO27XCtVbcfAcUgmqEOZeB_iOkuyn430",
            authDomain: "quizz-60cd5.firebaseapp.com",
            projectId: "quizz-60cd5",
            storageBucket: "quizz-60cd5.firebasestorage.app",
            messagingSenderId: "641406307480",
            appId: "1:641406307480:web:e780be16f344ddd3f254ed",
            measurementId: "G-647GNPBVHM"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // Global variables
        window.currentUser = null;
        window.currentRoom = null;
        window.currentGame = null;
        window.isVIP = false;
        window.selectedTheme = null;
        window.playerReady = false;
        window.roomListener = null;

        // Sample themes data (this would normally be loaded from Firestore or files)
        window.themes = [
            {
                id: 'geografia',
                name: 'Geografia',
                description: 'Teste seus conhecimentos sobre o mundo',
                creator: 'Sistema',
                questions: [
                    {
                        question: 'Qual é a capital do Brasil?',
                        options: ['São Paulo', 'Rio de Janeiro', 'Brasília', 'Belo Horizonte'],
                        correct: 2
                    },
                    {
                        question: 'Qual é o maior país do mundo?',
                        options: ['China', 'Estados Unidos', 'Canadá', 'Rússia'],
                        correct: 3
                    },
                    {
                        question: 'Quantos continentes existem?',
                        options: ['5', '6', '7', '8'],
                        correct: 2
                    }
                ]
            },
            {
                id: 'historia',
                name: 'História',
                description: 'Viaje pelo tempo e teste seus conhecimentos',
                creator: 'Sistema',
                questions: [
                    {
                        question: 'Em que ano o Brasil foi descoberto?',
                        options: ['1492', '1500', '1502', '1510'],
                        correct: 1
                    },
                    {
                        question: 'Quem foi o primeiro presidente do Brasil?',
                        options: ['Getúlio Vargas', 'Deodoro da Fonseca', 'Floriano Peixoto', 'Prudente de Morais'],
                        correct: 1
                    },
                    {
                        question: 'Em que ano terminou a Segunda Guerra Mundial?',
                        options: ['1943', '1944', '1945', '1946'],
                        correct: 2
                    }
                ]
            },
            {
                id: 'ciencias',
                name: 'Ciências',
                description: 'Explore o mundo da ciência',
                creator: 'Sistema',
                questions: [
                    {
                        question: 'Qual é o planeta mais próximo do Sol?',
                        options: ['Vênus', 'Terra', 'Mercúrio', 'Marte'],
                        correct: 2
                    },
                    {
                        question: 'Quantos ossos tem o corpo humano adulto?',
                        options: ['186', '206', '226', '246'],
                        correct: 1
                    },
                    {
                        question: 'Qual é a fórmula química da água?',
                        options: ['H2O', 'CO2', 'O2', 'N2'],
                        correct: 0
                    }
                ]
            }
        ];

        // Auth state observer
        onAuthStateChanged(auth, (user) => {
            if (user) {
                window.currentUser = user;
                document.getElementById('loginBtn').style.display = 'none';
                document.getElementById('logoutItem').style.display = 'block';
                document.getElementById('userInfo').style.display = 'block';
                document.getElementById('userName').textContent = user.displayName;
                document.getElementById('userAvatar').src = user.photoURL;
                
                // Check VIP status
                checkVIPStatus(user.uid);
                
                // Show dashboard
                showPage('dashboardPage');
            } else {
                window.currentUser = null;
                document.getElementById('loginBtn').style.display = 'block';
                document.getElementById('logoutItem').style.display = 'none';
                document.getElementById('userInfo').style.display = 'none';
                showPage('loginPage');
            }
        });

        // Login with Google
        document.getElementById('googleLoginBtn').addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;
                
                // Save user to Firestore
                await setDoc(doc(db, 'users', user.uid), {
                    uid: user.uid,
                    displayName: user.displayName,
                    email: user.email,
                    photoURL: user.photoURL,
                    lastLogin: serverTimestamp()
                }, { merge: true });
                
            } catch (error) {
                console.error('Login error:', error);
                alert('Erro ao fazer login. Tente novamente.');
            }
        });

        // Logout
        document.getElementById('logoutBtn').addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Check VIP Status
        async function checkVIPStatus(userId) {
            try {
                const vipDoc = await getDoc(doc(db, 'vipStatus', userId));
                window.isVIP = vipDoc.exists() && vipDoc.data().active;
                
                if (window.isVIP) {
                    document.getElementById('vipBtn').innerHTML = '<span class="vip-badge">VIP</span>';
                }
            } catch (error) {
                console.error('Error checking VIP status:', error);
            }
        }

        // Create Room
        document.getElementById('createRoomForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!window.currentUser) {
                alert('Você precisa estar logado para criar uma sala');
                return;
            }
            
            const roomName = document.getElementById('roomName').value;
            const visibility = document.getElementById('roomVisibility').value;
            const maxPlayers = parseInt(document.getElementById('maxPlayers').value);
            const minPlayers = parseInt(document.getElementById('minPlayers').value);
            const questionTime = parseInt(document.getElementById('questionTime').value);
            const showAnswers = document.getElementById('showAnswers').checked;
            const simultaneousAnswers = document.getElementById('simultaneousAnswers').checked;
            
            // Check VIP for max players
            if (maxPlayers > 6 && !window.isVIP) {
                alert('Apenas usuários VIP podem criar salas com mais de 6 jogadores');
                return;
            }
            
            // Generate room code
            const roomCode = generateRoomCode();
            
            try {
                const roomData = {
                    code: roomCode,
                    name: roomName,
                    visibility: visibility,
                    maxPlayers: maxPlayers,
                    minPlayers: minPlayers,
                    questionTime: questionTime,
                    showAnswers: showAnswers,
                    simultaneousAnswers: simultaneousAnswers,
                    creatorId: window.currentUser.uid,
                    creatorName: window.currentUser.displayName,
                    players: [{
                        uid: window.currentUser.uid,
                        displayName: window.currentUser.displayName,
                        photoURL: window.currentUser.photoURL,
                        ready: false,
                        score: 0
                    }],
                    status: 'waiting',
                    createdAt: serverTimestamp()
                };
                
                await setDoc(doc(db, 'rooms', roomCode), roomData);
                
                window.currentRoom = roomCode;
                enterRoomLobby(roomData);
                
            } catch (error) {
                console.error('Error creating room:', error);
                alert('Erro ao criar sala. Tente novamente.');
            }
        });

        // Generate random room code
        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let code = '';
            for (let i = 0; i < 6; i++) {
                code += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return code;
        }

        // Join room by code
        window.joinRoomByCode = async function() {
            const code = document.getElementById('roomCodeInput').value.toUpperCase();
            
            if (!code) {
                alert('Digite o código da sala');
                return;
            }
            
            if (!window.currentUser) {
                alert('Você precisa estar logado para entrar em uma sala');
                return;
            }
            
            try {
                const roomDoc = await getDoc(doc(db, 'rooms', code));
                
                if (!roomDoc.exists()) {
                    alert('Sala não encontrada');
                    return;
                }
                
                const roomData = roomDoc.data();
                
                if (roomData.players.length >= roomData.maxPlayers) {
                    alert('Sala cheia');
                    return;
                }
                
                // Add player to room
                const playerData = {
                    uid: window.currentUser.uid,
                    displayName: window.currentUser.displayName,
                    photoURL: window.currentUser.photoURL,
                    ready: false,
                    score: 0
                };
                
                await updateDoc(doc(db, 'rooms', code), {
                    players: arrayUnion(playerData)
                });
                
                window.currentRoom = code;
                enterRoomLobby({ ...roomData, code: code });
                
            } catch (error) {
                console.error('Error joining room:', error);
                alert('Erro ao entrar na sala. Tente novamente.');
            }
        };

        // Enter room lobby
        function enterRoomLobby(roomData) {
            showPage('roomLobbyPage');
            
            document.getElementById('lobbyRoomName').textContent = roomData.name;
            document.getElementById('lobbyRoomCode').textContent = roomData.code;
            document.getElementById('maxPlayersCount').textContent = roomData.maxPlayers;
            
            // Show start button for room creator
            if (roomData.creatorId === window.currentUser.uid) {
                document.getElementById('startGameBtn').style.display = 'inline-block';
            } else {
                document.getElementById('startGameBtn').style.display = 'none';
            }
            
            // Listen for room updates
            if (window.roomListener) {
                window.roomListener();
            }
            
            window.roomListener = onSnapshot(doc(db, 'rooms', roomData.code), (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    updateRoomLobby(data);
                    
                    // Check if game started
                    if (data.status === 'selectingTheme' && data.creatorId !== window.currentUser.uid) {
                        alert('O criador está selecionando o tema...');
                    } else if (data.status === 'playing') {
                        startGameForPlayer(data);
                    }
                }
            });
        }

        // Update room lobby
        function updateRoomLobby(roomData) {
            const playersList = document.getElementById('playersList');
            playersList.innerHTML = '';
            
            document.getElementById('currentPlayersCount').textContent = roomData.players.length;
            
            roomData.players.forEach(player => {
                const playerDiv = document.createElement('div');
                playerDiv.className = 'player-item';
                playerDiv.innerHTML = `
                    <div>
                        <img src="${player.photoURL}" alt="${player.displayName}" class="user-avatar">
                        <span>${player.displayName}</span>
                        ${player.uid === roomData.creatorId ? '<i class="fas fa-crown" style="color: gold; margin-left: 10px;"></i>' : ''}
                    </div>
                    ${player.ready ? '<span class="ready-badge">Pronto</span>' : ''}
                `;
                playersList.appendChild(playerDiv);
            });
            
            // Check if can start game
            if (roomData.creatorId === window.currentUser.uid) {
                const readyPlayers = roomData.players.filter(p => p.ready).length;
                const canStart = readyPlayers >= roomData.minPlayers;
                document.getElementById('startGameBtn').disabled = !canStart;
            }
        }

        // Toggle ready status
        window.toggleReady = async function() {
            if (!window.currentRoom) return;
            
            window.playerReady = !window.playerReady;
            
            try {
                const roomDoc = await getDoc(doc(db, 'rooms', window.currentRoom));
                const roomData = roomDoc.data();
                
                const updatedPlayers = roomData.players.map(p => {
                    if (p.uid === window.currentUser.uid) {
                        p.ready = window.playerReady;
                    }
                    return p;
                });
                
                await updateDoc(doc(db, 'rooms', window.currentRoom), {
                    players: updatedPlayers
                });
                
                document.getElementById('readyBtn').classList.toggle('btn-success-game');
                document.getElementById('readyBtn').classList.toggle('btn-secondary');
                document.getElementById('readyBtn').innerHTML = window.playerReady ? 
                    '<i class="fas fa-times"></i> Cancelar' : 
                    '<i class="fas fa-check"></i> Pronto';
                
            } catch (error) {
                console.error('Error toggling ready:', error);
            }
        };

        // Select theme
        window.selectTheme = async function() {
            if (!window.currentRoom) return;
            
            // Update room status
            await updateDoc(doc(db, 'rooms', window.currentRoom), {
                status: 'selectingTheme'
            });
            
            showPage('themeSelectionPage');
            
            // Load themes
            const themesList = document.getElementById('themesList');
            themesList.innerHTML = '';
            
            window.themes.forEach(theme => {
                const themeCard = document.createElement('div');
                themeCard.className = 'col-md-4';
                themeCard.innerHTML = `
                    <div class="theme-card" onclick="selectThemeCard('${theme.id}')">
                        <h4>${theme.name}</h4>
                        <p>${theme.description}</p>
                        <small>Por: ${theme.creator}</small>
                    </div>
                `;
                themesList.appendChild(themeCard);
            });
        };

        // Select theme card
        window.selectThemeCard = function(themeId) {
            window.selectedTheme = window.themes.find(t => t.id === themeId);
            
            // Update UI
            document.querySelectorAll('.theme-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        };

        // Start game
        window.startGame = async function() {
            if (!window.selectedTheme || !window.currentRoom) {
                alert('Selecione um tema primeiro');
                return;
            }
            
            try {
                // Update room with game data
                await updateDoc(doc(db, 'rooms', window.currentRoom), {
                    status: 'playing',
                    theme: window.selectedTheme,
                    currentQuestion: 0,
                    startTime: serverTimestamp()
                });
                
                // Start game for creator
                const roomDoc = await getDoc(doc(db, 'rooms', window.currentRoom));
                startGameForPlayer(roomDoc.data());
                
            } catch (error) {
                console.error('Error starting game:', error);
            }
        };

        // Start game for player
        function startGameForPlayer(roomData) {
            window.currentGame = {
                room: roomData,
                theme: roomData.theme,
                currentQuestion: 0,
                score: 0,
                answers: [],
                startTime: Date.now()
            };
            
            showPage('gamePage');
            showQuestion();
        }

        // Show question
        function showQuestion() {
            const game = window.currentGame;
            const question = game.theme.questions[game.currentQuestion];
            
            if (!question) {
                endGame();
                return;
            }
            
            document.getElementById('questionText').textContent = question.question;
            
            // Update progress
            const progress = ((game.currentQuestion + 1) / game.theme.questions.length) * 100;
            document.getElementById('questionProgress').style.width = progress + '%';
            
            // Show options
            const container = document.getElementById('answersContainer');
            container.innerHTML = '';
            
            question.options.forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'quiz-option';
                optionDiv.textContent = option;
                optionDiv.onclick = () => selectOption(index);
                container.appendChild(optionDiv);
            });
            
            // Start timer
            startQuestionTimer();
        }

        // Select option
        function selectOption(index) {
            document.querySelectorAll('.quiz-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            
            event.currentTarget.classList.add('selected');
            window.selectedAnswer = index;
            
            if (window.currentGame.room.simultaneousAnswers) {
                submitAnswer();
            } else {
                document.getElementById('submitAnswerBtn').style.display = 'inline-block';
            }
        }

        // Submit answer
        window.submitAnswer = function() {
            if (window.selectedAnswer === undefined) return;
            
            const game = window.currentGame;
            const question = game.theme.questions[game.currentQuestion];
            const isCorrect = window.selectedAnswer === question.correct;
            
            // Stop timer
            if (window.questionTimer) {
                clearInterval(window.questionTimer);
            }
            
            // Update score
            if (isCorrect) {
                game.score += 100;
            }
            
            // Save answer
            game.answers.push({
                question: game.currentQuestion,
                answer: window.selectedAnswer,
                correct: isCorrect,
                time: Date.now() - window.questionStartTime
            });
            
            // Show correct answer if configured
            if (game.room.showAnswers) {
                showCorrectAnswer(question.correct);
                setTimeout(() => {
                    nextQuestion();
                }, 2000);
            } else {
                nextQuestion();
            }
        };

        // Show correct answer
        function showCorrectAnswer(correctIndex) {
            document.querySelectorAll('.quiz-option').forEach((opt, index) => {
                if (index === correctIndex) {
                    opt.classList.add('correct');
                } else if (index === window.selectedAnswer && index !== correctIndex) {
                    opt.classList.add('incorrect');
                }
            });
        }

        // Next question
        function nextQuestion() {
            window.currentGame.currentQuestion++;
            window.selectedAnswer = undefined;
            document.getElementById('submitAnswerBtn').style.display = 'none';
            showQuestion();
        }

        // Start question timer
        function startQuestionTimer() {
            const time = window.currentGame.room.questionTime;
            let timeLeft = time;
            
            window.questionStartTime = Date.now();
            
            const timerElement = document.getElementById('gameTimer');
            timerElement.textContent = timeLeft;
            timerElement.classList.remove('warning');
            
            window.questionTimer = setInterval(() => {
                timeLeft--;
                timerElement.textContent = timeLeft;
                
                if (timeLeft <= 5) {
                    timerElement.classList.add('warning');
                }
                
                if (timeLeft <= 0) {
                    clearInterval(window.questionTimer);
                    submitAnswer();
                }
            }, 1000);
        }

        // End game
        async function endGame() {
            const game = window.currentGame;
            
            // Calculate stats
            const totalQuestions = game.theme.questions.length;
            const correctAnswers = game.answers.filter(a => a.correct).length;
            const avgTime = game.answers.reduce((sum, a) => sum + a.time, 0) / game.answers.length / 1000;
            
            // Update player score in room
            try {
                const roomDoc = await getDoc(doc(db, 'rooms', window.currentRoom));
                const roomData = roomDoc.data();
                
                const updatedPlayers = roomData.players.map(p => {
                    if (p.uid === window.currentUser.uid) {
                        p.score = game.score;
                        p.correctAnswers = correctAnswers;
                        p.totalQuestions = totalQuestions;
                        p.avgTime = avgTime;
                    }
                    return p;
                });
                
                await updateDoc(doc(db, 'rooms', window.currentRoom), {
                    players: updatedPlayers,
                    status: 'finished'
                });
                
                // Wait for all players to finish
                setTimeout(() => {
                    showResults(updatedPlayers);
                }, 2000);
                
            } catch (error) {
                console.error('Error ending game:', error);
            }
        }

        // Show results
        function showResults(players) {
            showPage('resultsPage');
            
            // Sort players by score
            players.sort((a, b) => b.score - a.score);
            
            // Show podium (top 3)
            const podiumContainer = document.getElementById('podiumContainer');
            podiumContainer.innerHTML = '';
            
            if (players.length >= 2) {
                // Second place
                const second = document.createElement('div');
                second.className = 'podium-place';
                second.innerHTML = `
                    <img src="${players[1].photoURL}" alt="${players[1].displayName}" class="user-avatar mb-2">
                    <div class="podium-2 d-flex align-items-center justify-content-center">
                        <div>
                            <h4>2º</h4>
                            <p>${players[1].displayName}</p>
                            <p>${players[1].score} pts</p>
                        </div>
                    </div>
                `;
                podiumContainer.appendChild(second);
            }
            
            if (players.length >= 1) {
                // First place
                const first = document.createElement('div');
                first.className = 'podium-place';
                first.innerHTML = `
                    <img src="${players[0].photoURL}" alt="${players[0].displayName}" class="user-avatar mb-2">
                    <div class="podium-1 d-flex align-items-center justify-content-center">
                        <div>
                            <h3>🏆</h3>
                            <h4>1º</h4>
                            <p>${players[0].displayName}</p>
                            <p>${players[0].score} pts</p>
                        </div>
                    </div>
                `;
                podiumContainer.appendChild(first);
            }
            
            if (players.length >= 3) {
                // Third place
                const third = document.createElement('div');
                third.className = 'podium-place';
                third.innerHTML = `
                    <img src="${players[2].photoURL}" alt="${players[2].displayName}" class="user-avatar mb-2">
                    <div class="podium-3 d-flex align-items-center justify-content-center">
                        <div>
                            <h4>3º</h4>
                            <p>${players[2].displayName}</p>
                            <p>${players[2].score} pts</p>
                        </div>
                    </div>
                `;
                podiumContainer.appendChild(third);
            }
            
            // Show full results
            const fullResults = document.getElementById('fullResultsList');
            fullResults.innerHTML = '<h4>Resultados Completos:</h4>';
            
            players.forEach((player, index) => {
                const resultDiv = document.createElement('div');
                resultDiv.className = 'player-item mb-2';
                resultDiv.innerHTML = `
                    <div>
                        <strong>${index + 1}º</strong>
                        <img src="${player.photoURL}" alt="${player.displayName}" class="user-avatar">
                        <span>${player.displayName}</span>
                    </div>
                    <div>
                        <span class="badge bg-primary">${player.score} pts</span>
                        <span class="badge bg-success">${player.correctAnswers || 0}/${player.totalQuestions || 0}</span>
                        <span class="badge bg-info">${(player.avgTime || 0).toFixed(1)}s</span>
                    </div>
                `;
                fullResults.appendChild(resultDiv);
            });
        }

        // Back to lobby
        window.backToLobby = async function() {
            if (!window.currentRoom) return;
            
            try {
                // Reset room status
                await updateDoc(doc(db, 'rooms', window.currentRoom), {
                    status: 'waiting',
                    theme: null,
                    currentQuestion: 0
                });
                
                // Reset player ready status
                const roomDoc = await getDoc(doc(db, 'rooms', window.currentRoom));
                const roomData = roomDoc.data();
                
                const updatedPlayers = roomData.players.map(p => {
                    p.ready = false;
                    p.score = 0;
                    return p;
                });
                
                await updateDoc(doc(db, 'rooms', window.currentRoom), {
                    players: updatedPlayers
                });
                
                enterRoomLobby(roomData);
                
            } catch (error) {
                console.error('Error returning to lobby:', error);
            }
        };

        // Leave room
        window.leaveRoom = async function() {
            if (!window.currentRoom) return;
            
            try {
                const roomDoc = await getDoc(doc(db, 'rooms', window.currentRoom));
                const roomData = roomDoc.data();
                
                // Remove player from room
                const updatedPlayers = roomData.players.filter(p => p.uid !== window.currentUser.uid);
                
                if (updatedPlayers.length === 0) {
                    // Delete room if empty
                    await deleteDoc(doc(db, 'rooms', window.currentRoom));
                } else {
                    // Update room
                    await updateDoc(doc(db, 'rooms', window.currentRoom), {
                        players: updatedPlayers
                    });
                    
                    // If creator left, assign new creator
                    if (roomData.creatorId === window.currentUser.uid && updatedPlayers.length > 0) {
                        await updateDoc(doc(db, 'rooms', window.currentRoom), {
                            creatorId: updatedPlayers[0].uid,
                            creatorName: updatedPlayers[0].displayName
                        });
                    }
                }
                
                // Stop listening to room updates
                if (window.roomListener) {
                    window.roomListener();
                    window.roomListener = null;
                }
                
                window.currentRoom = null;
                showDashboard();
                
            } catch (error) {
                console.error('Error leaving room:', error);
            }
        };

        // Copy room code
        window.copyRoomCode = function() {
            const code = document.getElementById('lobbyRoomCode').textContent;
            navigator.clipboard.writeText(code).then(() => {
                alert('Código copiado: ' + code);
            });
        };

        // Show public rooms
        window.showPublicRooms = async function() {
            showPage('publicRoomsPage');
            
            try {
                const q = query(collection(db, 'rooms'), where('visibility', '==', 'public'), where('status', '==', 'waiting'));
                const querySnapshot = await getDocs(q);
                
                const roomsList = document.getElementById('publicRoomsList');
                roomsList.innerHTML = '';
                
                if (querySnapshot.empty) {
                    roomsList.innerHTML = '<p class="text-center">Nenhuma sala pública disponível</p>';
                    return;
                }
                
                querySnapshot.forEach((doc) => {
                    const room = doc.data();
                    const roomDiv = document.createElement('div');
                    roomDiv.className = 'room-card';
                    roomDiv.innerHTML = `
                        <h4>${room.name}</h4>
                        <p>Criador: ${room.creatorName}</p>
                        <p>Jogadores: ${room.players.length}/${room.maxPlayers}</p>
                        <p>Código: ${room.code}</p>
                    `;
                    roomDiv.onclick = () => {
                        document.getElementById('roomCodeInput').value = room.code;
                        joinRoomByCode();
                    };
                    roomsList.appendChild(roomDiv);
                });
                
            } catch (error) {
                console.error('Error loading public rooms:', error);
            }
        };

        // Perform search
        window.performSearch = function() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            
            if (!searchTerm) {
                alert('Digite algo para pesquisar');
                return;
            }
            
            // Update URL
            window.location.hash = `search?search=${encodeURIComponent(searchTerm)}`;
            
            // Search logic would go here
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = `<p>Pesquisando por: "${searchTerm}"</p>`;
            
            // This would normally search Firestore
            resultsDiv.innerHTML += '<p class="text-muted">Nenhum resultado encontrado</p>';
        };

        // Mercado Pago Checkout
        window.initiateMercadoPagoCheckout = function() {
            // This would integrate with Mercado Pago API
            alert('Integração com Mercado Pago será implementada com backend próprio');
            
            // For demonstration, we'll simulate VIP activation
            setTimeout(() => {
                window.isVIP = true;
                document.getElementById('vipBtn').innerHTML = '<span class="vip-badge">VIP</span>';
                alert('VIP ativado com sucesso!');
                showDashboard();
            }, 2000);
        };

        // Navigation functions
        window.showPage = function(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        };

        window.showDashboard = function() {
            if (!window.currentUser) {
                showPage('loginPage');
                return;
            }
            showPage('dashboardPage');
            window.location.hash = 'dashboard';
        };

        window.showCreateRoom = function() {
            if (!window.currentUser) {
                alert('Faça login primeiro');
                return;
            }
            showPage('createRoomPage');
        };

        window.showJoinRoom = function() {
            if (!window.currentUser) {
                alert('Faça login primeiro');
                return;
            }
            showPage('joinRoomPage');
        };

        // Handle URL routing
        function handleRouting() {
            const hash = window.location.hash.slice(1);
            
            if (hash.startsWith('search')) {
                showPage('searchPage');
                const params = new URLSearchParams(hash.split('?')[1]);
                const searchTerm = params.get('search');
                if (searchTerm) {
                    document.getElementById('searchInput').value = searchTerm;
                    performSearch();
                }
            } else if (hash === 'dashboard') {
                showDashboard();
            } else if (hash.includes('?id=')) {
                // Room URL
                const params = new URLSearchParams(hash.split('?')[1]);
                const roomId = params.get('id');
                if (roomId) {
                    document.getElementById('roomCodeInput').value = roomId;
                    showPage('joinRoomPage');
                }
            }
        }

        // Event listeners
        document.getElementById('loginBtn').addEventListener('click', () => showPage('loginPage'));
        document.getElementById('vipBtn').addEventListener('click', () => showPage('vipPage'));
        
        window.addEventListener('hashchange', handleRouting);
        
        // Initial routing
        handleRouting();
    </script>
</body>
</html>